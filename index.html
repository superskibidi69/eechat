<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Free collab chat interface">
  <meta name="author" content="superfood">
  <meta name="theme-color" content="#0084ff">
  
  <title>eeechat</title>
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">

  <!-- Styles -->
  <style>
    * { box-sizing: border-box; }
    body { font-family: 'Roboto', sans-serif; margin:0; display:flex; flex-direction:column; height:100vh; background: linear-gradient(135deg,#89f7fe,#66a6ff); }
    #chatContainer { flex:1; padding:15px; overflow-y:auto; backdrop-filter: blur(15px); background: rgba(255,255,255,0.15); margin: 10px; border-radius: 20px; display:flex; flex-direction:column; }
    .msg { display:flex; align-items:center; margin:6px 0; padding:10px 14px; border-radius:15px; max-width:70%; word-wrap: break-word; backdrop-filter: blur(10px); background: rgba(255,255,255,0.2); transition: all 0.2s; }
    .msg.me { margin-left:auto; background: rgba(0,132,255,0.8); color:white; }
    .msg.other { margin-right:auto; background: rgba(255,255,255,0.3); color:black; }
    .msg.system { margin:0 auto; background: rgba(255,255,255,0.25); font-style:italic; color:#333; }
    .msg img { width:30px; height:30px; border-radius:50%; margin-right:10px; object-fit:cover; }
    #inputArea { display:flex; padding:10px; background: rgba(255,255,255,0.15); backdrop-filter: blur(15px); border-radius:25px; margin:10px; }
    #messageInput { flex:1; padding:10px 15px; border:1px solid rgba(255,255,255,0.3); border-radius:25px; outline:none; background: rgba(255,255,255,0.25); color:black; }
    button { margin-left:10px; padding:10px 20px; border:none; border-radius:25px; background: #0084ff; color:white; cursor:pointer; transition:0.2s; }
    button:hover { background:#005bb5; }
  </style>
</head>

<body>

<div id="chatContainer"></div>

<div id="inputArea">
  <input type="text" id="messageInput" placeholder="Type a message">
  <button onclick="sendMessage()">Send</button>
</div>

<script>
const chatContainer = document.getElementById("chatContainer");
const input = document.getElementById("messageInput");

// load or set username
let username = localStorage.getItem("chat_username");
if(!username) {
  username = prompt("Choose a username") || "anon" + Math.floor(Math.random()*1000);
  localStorage.setItem("chat_username", username);
}

// load or set avatar
let avatar = localStorage.getItem("chat_avatar");
if(!avatar) {
  avatar = prompt("Paste URL for avatar (or leave blank)") || "https://i.pravatar.cc/50?u="+username;
  localStorage.setItem("chat_avatar", avatar);
}

// load messages from localStorage
let messages = JSON.parse(localStorage.getItem("chat_messages") || "[]");
messages.forEach(m=>addMsg(m.text,m.type,m.user,m.avatar));

// websocket
const ws = new WebSocket("wss://chat-ws-4lbe.onrender.com/");
ws.onopen = ()=>{
  // tell server our username
  ws.send(JSON.stringify({user:username,text:""}));
};

ws.onmessage = e=>{
  try{
    const data = JSON.parse(e.data);
    if(data.system){
      addMsg(data.system,"system");
    } else {
      const type = data.user === username ? "me" : "other";
      addMsg(data.text,type,data.user,data.avatar || "https://i.pravatar.cc/50?u="+data.user,true);
    }
  } catch(err){ addMsg("bad data","system"); }
};

ws.onclose = ()=> addMsg("Disconnected","system");
ws.onerror = ()=> addMsg("Error","system");

// add message
function addMsg(text,type,user="",avatarUrl="",fromServer=false){
  const div = document.createElement("div");
  div.className = "msg "+type;

  if(type !== "system"){
    const img = document.createElement("img");
    img.src = avatarUrl || "https://i.pravatar.cc/50";
    div.appendChild(img);
    const span = document.createElement("span");
    span.textContent = `${user}: ${text}`;
    div.appendChild(span);
  } else {
    div.textContent = text;
  }

  chatContainer.appendChild(div);
  chatContainer.scrollTop = chatContainer.scrollHeight;

  // save message locally (only once per msg)
  if(!fromServer) {
    messages.push({text,type,user,avatar:avatarUrl});
    localStorage.setItem("chat_messages",JSON.stringify(messages));
  }
}// send message
function sendMessage(){
  const msg = input.value.trim();
  if(!msg) return;
  const payload = {user:username,text:msg,avatar:avatar};
  ws.send(JSON.stringify(payload));
  input.value="";
}


input.addEventListener("keydown",e=>{ if(e.key==="Enter") sendMessage(); });

</script>
</body>
</html>
